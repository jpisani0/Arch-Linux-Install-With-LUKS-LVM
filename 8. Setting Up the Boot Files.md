## Changing the Shell to the Installation

We are now ready to enter an interactive shell in our installation to be able to install more packages, set of the configuration files, etc. To do this, we will do:

```bash
arch-chroot /mnt /bin/bash
```

You should now see that we are in the root directory we made, mounted at `/mnt`.

## Generating the initramfs

We will be editing the file `/etc/mkinitcpio.conf` before generating the initramfs used to boot the system. To do this you will need an in-terminal text editor. I prefer `neovim` but I would recommend `nano` to anyone who doesn't know vim with:

```bash
pacman -S nano
```

We will then edit the configuration file with:

```bash
nano /etc/mkinitcpio.conf
```

Now that it is open, we need to fine the `HOOKS=()` line. You will see many hooks already listed there. You will want your `HOOKS` line to look like this:

```bash
HOOKS=(base systemd autodetect microcode modconf kms keyboard keymap sd-vconsole block sd-encrypt lvm2 filesystems fsck)
```

The important hooks to add, as most of these will probably be there already, are the `sd-encrypt` and `lvm2` hooks in between the `block` and `filesystems` hooks. These are needed to decrypt our LUKS partitions at boot and load the LVM. After you save and close the file, we will also need to install the `lvm2` package with:

```bash
pacman -S lvm2
```

Now, we can generate the initramfs with:

```bash
mkinitcpio -P
```


## Installing the Bootloader

We now need to install a bootloader to actually boot into the system. I use `grub`, so we will need to install these packages:

```bash
pacman -S grub efibootmgr
```

With the packages installed, we can install the grub bootloader with:

```bash
grub-install --target=x86_64-efi --efi-directory=/boot/ --bootloader-id=GRUB
```

Change the `target` if your machine is a different platform and feel free the change the bootloader ID to whatever you prefer.

Now that `grub` is installed, we can open its configuration file with:

```bash
nano /etc/default/grub
```

You will see a line near the start of the file that starts with `GRUB_CMDLINE_LINUX_DEFAULT`. We will need to edit this line since we are encrypting and using an LVM. We first need to add the kernel options letting the initramfs know that we have encrypted devices that need to be decrypted at boot by prompting for a passphrase. We need to first get the UUIDs of our encrypted device(s). We can do this with:

```bash
blkid /dev/<your-device>
```

Once you have the UUIDs of your device(s), you can add this to your `GRUB_CMDLINE_LINUX_DEFAULT` line:

```bash
rd.luks.name=<device1-UUID>=luks_lvm0 rd.luks.name=<device2-UUID>=luks_lvm1 ...
```

Add for every encrypted device you have. Then, we can specify the root file system for our installation on that same line with:

```bash
root=/dev/mapper/<your-root-volume> rw
```

The `rw` at the end tells the kernel to mount the root file system as read/write on boot.

We can now generate out `grub.cfg` file for boot with:

```bash
grub-mkconfig -o /boot/grub/grub.cfg
```

## Setting Up Dual Boot with Windows or Other Linux Distro

If you are planning to dual boot this Arch Linux installation with another OS, you will want to have it be an option in your `grub` boot menu as well for ease of use. You will first need to install the `os-prober` package:

```bash
pacman -S os-prober
```

We will then need to open the `grub` configuration and edit it again with:

```bash
nano /etc/default/grub
```

You will see a line near the bottom of the file:

```bash
# GRUB_DISABLE_OS_PROBER=false
```

The `#` is a comment, meaning this line isn't actually being read when `grub-mkconfig` is called, so we will need to uncomment this line by deleting it. Then, we can regenerate our `grub.cfg` files with:

```bash
grub-mkconfig -o /boot/grub/grub.cfg
```

You will probably see some warnings in the output about using `os-prober` which can be ignored.