## Changing the Shell to the Installation

We are now ready to enter an interactive shell in our installation to be able to install more packages, set of the configuration files, etc. To do this, we will do:

```bash
arch-chroot /mnt /bin/bash
```

You should now see that we are in the root directory we made, mounted at `/mnt`.

## Generating the initramfs

We will be editing the file `/etc/mkinitcpio.conf` before generating the initramfs used to boot the system. To do this you will need an in-terminal text editor. I prefer `neovim` but I would recommend `nano` to anyone who doesn't know vim with:

```bash
pacman -S nano
```

We will then edit the configuration file with:

```bash
nano /etc/mkinitcpio.conf
```

Now that it is open, we need to fine the `HOOKS=()` line. You will see many hooks already listed there. Find the `block` and `filesystems` hooks, and in between them, add `encrypt` and `lvm2`.  After you save and close the file, we will need to install the `lvm2` package for this hook with:

```bash
pacman -S lvm2
```

Now, we can generate the initramfs with:

```bash
mkinitcpio -P
```


## Installing the Bootloader

We now need to install a bootloader to actually boot into the system. I use `grub`, so we will need to install these packages:

```bash
pacman -S grub efibootmgr
```

With the packages installed, we can install the grub bootloader with:

```bash
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB
```

Change the `target` if your machine is a different platform and feel free the change the bootloader ID to whatever you prefer.

Now that `grub` is installed, we can open its configuration file with:

```bash
nano /etc/default/grub
```

You will see a line near the start of the file that starts with `GRUB_CMDLINE_LINUX_DEFAULT`. We will need to edit this line since we are encrypting and using an LVM. First, we will add this to end of that line within the quotes:

```bash
root=/dev/mapper/<your-root-volume>
```

This lets `grub` know what device to look for for the root partition. We will then need to also let `grub` know that our root device is encrypted by adding this after the above text:

```bash
cryptdevice=/dev/<your-encrypted-device>:luks_lvm0
```

This, however, is actually bad practice, as there is a chance that the drives get switched up by there standard file names (/dev/sda and /dev/sdb switch between boots for example). Instead, we will want to replace this with the device's UUID by doing:

```bash
blkid /dev/<your-encrypted-device>
```

Copy the UUID for the device and replace the above cryptdevice line with:

```bash
cryptdevice=UUID=<your-device-UUID>:luks_lvm0
```

This will now point to the same device between boots, even if they change order on your machine. We can now generate our 2 `grub.cfg` files, 1 for the EFI partition and 1 for boot, with:

```bash
grub-mkconfig -o /boot/grub/grub.cfg
grub-mkconfig -o /boot/efi/EFI/GRUB/grub.cfg
```

## Setting Up Dual Boot with Windows or Other Linux Distro

If you are planning to dual boot this Arch Linux installation with another OS, you will want to have it be an option in your `grub` boot menu as well for ease of use. You will first need to install the `os-prober` package:

```bash
pacman -S os-prober
```

We will then need to open the `grub` configuration and edit it again with:

```bash
nano /etc/default/grub
```

You will see a line near the bottom of the file:

```bash
# GRUB_DISABLE_OS_PROBER=false
```

The `#` is a comment, meaning this line isn't actually being read when `grub-mkconfig` is called, so we will need to uncomment this line by deleting it. Then, we can regenerate our `grub.cfg` files with:

```bash
grub-mkconfig -o /boot/grub/grub.cfg
grub-mkconfig -o /boot/efi/EFI/GRUB/grub.cfg
```

You will probably see some warnings in the output about using `os-prober` which can be ignored.